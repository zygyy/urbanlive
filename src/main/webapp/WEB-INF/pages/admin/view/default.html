<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>后台首页</title></head>
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<script src="/js/page.js"></script>
<link href="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
<link type="text/css" rel="stylesheet" href="/css/style.css">
<body>
<center>

    <table id="searchResult" border="0" cellpadding="0" cellspacing="0" width="650" height="500">
        <thead>
        </thead>
        <tbody></tbody>
    </table>

    <!--显示分页信息-->
    <div class="row">
        <!--分页文字信息-->
        <div class="col-md-6" align="left" id="page_info_area">
        </div>
        <!--分页条信息-->
        <div class="col-md-6" align="right" id="page_nav_area">
        </div>
    </div>
</center>
</body>
<script>
    /*编辑用户信息事件*/
    $(document).on("click", ".edit_btn", function () {
        var user_id = $(this).attr("edit-id");
        $.ajax({
            url: "/user/selectById",
            type: "post",
            data: {
                id: user_id
            },
            success: function (result) {
                build_result_select_user_edit(result);
            }
        })
    });


    /*构建修改面板*/
    function build_result_select_user_edit(result) {
        var user = result.data;
        $("#searchResult thead").empty();
        $("#searchResult tbody").empty();
        var user_id = $("<td></td>").append('用户ID');
        var user_id_input = $("<td></td>").append(user.id);
        var user_name = $("<td></td>").append('用户名');
        var name_input = $("<input/>").val(user.user_name);
        name_input.attr('id', 'name_input');
        var user_name_input = $("<td></td>").append(name_input);
        var user_pwd = $("<td></td>").append('用户密码');
        var pwd_input = $("<input/>");
        pwd_input.attr('type', 'password');
        pwd_input.attr('id', 'pwd_input');
        pwd_input.val('');
        var user_pwd_input = $("<td></td>").append($(pwd_input));
        var updateBtn = $("<button></button>").addClass("btn btn-success btn-sm update_btn")
            .append($("<span></span>").addClass("glyphicon glyphicon-pencil").append("Update"));
        //为编辑按钮添加一个自定义的属性，来表示当前用户id
        updateBtn.attr("update-id", user.id);
        $("<tr></tr>").append(user_id)
            .append(user_id_input)
            .appendTo("#searchResult thead");
        $("<tr></tr>").append(user_name)
            .append(user_name_input)
            .appendTo("#searchResult tbody");
        $("<tr></tr>").append(user_pwd)
            .append(user_pwd_input)
            .appendTo("#searchResult tbody")
        $("<tr></tr>").append(updateBtn)
            .appendTo("#searchResult tbody");
    }


    //给更新按钮添加点击绑定事件
    $(document).on("click",".update_btn",function () {
        var user_id = $(this).attr("update-id");
        var user_name = document.getElementById("name_input").value;
        var user_pwd = document.getElementById("pwd_input").value;
        $.ajax({
            url:"/user/update",
            type:"post",
            data:{
                id:user_id,
                user_name:user_name,
                user_password:user_pwd
            },
            success:function (result) {
                alert(result.message);
                getUsersNotAdmin(1);
            }
        })
    });


    /*删除用户事件响应*/
    $(document).on("click", ".delete_btn", function () {
        var user_id = $(this).attr("del-id");
        var user_name = $(this).parents("tr").find("td:eq(1)").text();
        if (confirm("确认删除【" + user_name + "】吗？")) {
            //确认，发送ajax请求到后台删除即可
            $.ajax({
                url: "/user/del",
                type: "post",
                data: {
                    id: user_id
                },
                success: function (result) {
                    alert(result.message);

                    getUsersNotAdmin(1);
                }
            });
        }
    });


    window.onload = function () {
        getUsersNotAdmin(1);
    }

    function getUsersNotAdmin(pageNum) {
        var pageSize = 5;
        $.ajax({
            url: "/user/select",
            type: "post",
            data: {
                pageNum: pageNum,
                pageSize: pageSize
            },
            success: function (result) {
                build_result_user(result);
                build_page_info(result);
                build_page_navUser(result);
            }
        })
    }


    /*生成查询到的用户的相应信息*/
    function build_result_user(result) {
        $("#searchResult thead").empty();
        $("#searchResult tbody").empty();
        var users = result.data.list;
        var id = $("<td></td>").append('用户ID');
        var user_name = $("<td></td>").append('用户名');
        var option = $("<td></td>").append('操作');
        $("<tr></tr>").append(id)
            .append(user_name)
            .append(option)
            .appendTo("#searchResult thead");
        $.each(users, function (index, item) {
            var user_id_1 = $("<td></td>").append(item.id);
            var user_name_1 = $("<td></td>").append(item.user_name);
            var editBtn = $("<button></button>").addClass("btn btn-success btn-sm edit_btn")
                .append($("<span></span>").addClass("glyphicon glyphicon-pencil").append("修改"));
            //为编辑按钮添加一个自定义的属性，来表示当前用户id
            editBtn.attr("edit-id", item.id);
            var delBtn = $("<button></button>").addClass("btn btn-danger btn-sm delete_btn")
                .append($("<span></span>").addClass("glyphicon glyphicon-trash").append("删除"));
            delBtn.attr("del-id", item.id);
            var btnTd = $("<td></td>").append(editBtn).append(" | ").append(delBtn);
            $("<tr></tr>").append(user_id_1)
                .append(user_name_1)
                .append(btnTd)
                .appendTo("#searchResult tbody");
        });
    }


    function searchInfoDefault(pN) {
        var pageSize = 5;
        var type = window.localStorage.getItem("info_type");
        var pay = window.localStorage.getItem("info_payfor");
        var check = window.localStorage.getItem("info_check");
        $.ajax({
            url: "/info/select",
            type: "post",
            data: {
                pageNum: pN,
                pageSize: pageSize,
                info_type: type,
                info_payfor: pay,
                info_check: check
            },
            success: function (result) {
                build_result(result);
                build_page_info(result);
                build_page_navDefault(result);
            }
        })
    }

    /*生成查询到的tb_info表的相应信息*/
    function build_result(result) {
        $("#searchResult thead").empty();
        $("#searchResult tbody").empty();
        var infos = result.data.list;
        var id = $("<td></td>").append('序号');
        var infoType = $("<td></td>").append('信息类别');
        var infoId = $("<td></td>").append('ID值');
        var infoTitle = $("<td></td>").append('信息标题');
        var infoDate = $("<td></td>").append('发布时间');
        var infoLinkman = $("<td></td>").append('联系人');
        $("<tr></tr>").append(id)
            .append(infoType)
            .append(infoId)
            .append(infoTitle)
            .append(infoDate)
            .append(infoLinkman)
            .appendTo("#searchResult thead");
        $.each(infos, function (index, item) {
            var id = $("<td></td>").append(index + 1);
            var infoType = $("<td></td>").append(item.tb_type.type_name);
            var infoId = $("<td></td>").append(item.id);
            var infoTitle = $("<td></td>").append(item.info_title);
            var infoDate = $("<td></td>").append(item.info_date);
            var infoLinkman = $("<td></td>").append(item.info_linkman);
            $("<tr></tr>").append(id)
                .append(infoType)
                .append(infoId)
                .append(infoTitle)
                .append(infoDate)
                .append(infoLinkman)
                .appendTo("#searchResult tbody");
        })
    }


    function getUserByUserId() {
        var selectuserid = window.localStorage.getItem("selectuserid");
        $.ajax({
            url: "/user/selectById",
            type: "post",
            data: {
                id: selectuserid,
            },
            success: function (result) {
                build_result_selectuser(result)
            }
        })
    }

    /*根据id查询到的用户*/
    function build_result_selectuser(result) {
        $("#searchResult thead").empty();
        $("#searchResult tbody").empty();
        var user = result.data;
        if (user != null) {
            var id = $("<td></td>").append('用户ID');
            var user_name = $("<td></td>").append('用户名');
            var option = $("<td></td>").append('操作');
            $("<tr></tr>").append(id)
                .append(user_name)
                .append(option)
                .appendTo("#searchResult thead");
            var user_id_1 = $("<td></td>").append(user.id);
            var user_name_1 = $("<td></td>").append(user.user_name);
            var editBtn = $("<button></button>").addClass("btn btn-success btn-sm edit_btn")
                .append($("<span></span>").addClass("glyphicon glyphicon-pencil").append("修改"));
            //为编辑按钮添加一个自定义的属性，来表示当前用户id
            editBtn.attr("edit-id", user.id);
            var delBtn = $("<button></button>").addClass("btn btn-danger btn-sm delete_btn")
                .append($("<span></span>").addClass("glyphicon glyphicon-trash").append("删除"));
            delBtn.attr("del-id", user.id);
            var btnTd = $("<td></td>").append(editBtn).append(" | ").append(delBtn);
            $("<tr></tr>").append(user_id_1)
                .append(user_name_1)
                .append(btnTd)
                .appendTo("#searchResult tbody");
        } else {
            alert("查无此人！请重新确定ID！")
            getUsersNotAdmin(1);
        }
    }


</script>
</html>